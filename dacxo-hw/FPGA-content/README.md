# FPGA configuration
The FPGA is a Lattice Semiconductor MachXO2 family device, in particular the LCMXO2-1200HC-4TG100I.
It has internal flash storage, so an external flash memory is not needed.
It contains 1200 LUTs and 7 SRAM blocks of 9kbit each.
It is housed in 100-pin TQFP package, which can still (barely) be hand-soldered on the PCB.
Lattice was (is) one of the few FPGA companies that provides free use of their programming software tools,
and their chips are easily available in small quantities.

The FPGA source files with the logic functionality are written in [verilog](https://en.wikipedia.org/wiki/Verilog).
They are provided as *xxx.v* files in the `impl1/source/` folder.

The main audio sample fifo buffer `Ipexpr_fifo` was generated by the tooling from a parameterized description,
to use the FPGA embedded SRAM blocks.
It has a width of 9 bits and a depth of 4K: the audio data is passed through in bytes,
with an extra leading bit denoting the left/right audio channel.
The bit-serial s/pdif data stream is passed as 3 bytes per sample (24 bits audio resolution).
For the left and right audio channel together, that takes 6 bytes per sample period.
That means that the audio buffer can store (4k/6) is 682 sample periods.

The FPGA is software-accessible at run time, at i2c bus address 0x10.
It provides four i2c addressable byte-registers. Two registers are 'rw' (read-write access),
the other two are 'ro' (read-only access).

| Register | bitposition | function |
|----------|-------------|----------|
| 0x30  rw |           7 | power_up |
|          |    bit[6,4] | unused   |
|          |    bit[3,2] | sample rate in master (i2s) mode, |
|          |             | input select in slave (spdif) mode  |
|          |        bit1 | master_base48 |
|          |        bit0 | master_mode (i2s), not slave (spdif) |
| 0x31  rw |    bit[7,1] | unused |
|          |        bit0 | att20db  1: 20dB attenuation on analog audio out, |
|          |             | 0: no attenuation |
| 0x34  ro |        bit7 | fifo is almost_full |
|          |        bit6 | fifo is almost_empty |
|          |        bit5 | clock adjust low |
|          |        bit4 | clock adjust high |
|          |    bit[3,2] | rate select 0: none, 1: 44/48kHz, |
|          |             | 2: 88/96kHz, 3: 176/192kHz |
|          |        bit1 | enable osc49M, not osc45M |
|          |        bit0 | spdif receiver lock: 1:locked, 0:no lock |
| 0x35  ro |    bit[7,6] | 0 |
|          |        bit5 | fifo is_full |
|          |        bit4 | fiifo is_empty |
|          |        bit3 | rx_lock |
|          |        bit2 | PIN_ext4: reset dacs, active low |
|          |        bit1 | PIN_ext5 |
|          |        bit0 | PIN_Vana: stay in reset if Vana is low |

When the i2s input is selected, the spdif reveiver is not used. In i2s mode,
the fpga becomes the clock master to the i2s interface. Hence, the fifo buffer
is not used, nor is the +/- 0.1% clock rate adjustment.

The `synthesis.log` shows that 5 of the 7 memory blocks are used, and only a small fraction of the available logic.
The final generated image to be written in the fpga is provided here as `dacxo201502_impl1.jed` (in jedec format).
